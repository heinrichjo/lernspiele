<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Autobahn Meister - Das Lernspiel</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel für JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #f5f5f4; touch-action: manipulation; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo } = React;

        // --- ICONS ---
        const IconMap = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21 3 6"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>;
        const IconNavigation = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"/></svg>;
        const IconMapPin = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>;
        const IconTrophy = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
        const IconPlay = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="6 3 20 12 6 21 6 3"/></svg>;
        const IconRotateCcw = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;
        const IconCheckCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>;
        const IconXCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>;
        const IconUndo = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>;
        const IconArrowRight = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>;
        const IconTarget = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>;
        const IconFlag = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg>;
        const IconListOrdered = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="10" x2="21" y1="6" y2="6"/><line x1="10" x2="21" y1="12" y2="12"/><line x1="10" x2="21" y1="18" y2="18"/><path d="M4 6h1v4"/><path d="M4 10h2"/><path d="M6 18H4c0-1 2-2 2-3s-1-1.5-2-1"/></svg>;
        const IconTrash2 = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const IconX = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>;
        const IconShuffle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 18h1.4c1.3 0 2.5-.6 3.3-1.7l14.2-12.4"/><path d="M22 2v5h-5"/><path d="M22 17v5h-5"/><path d="M2 6h1.4c1.3 0 2.5.6 3.3 1.7l3.3 2.9"/><path d="M16.6 16.6 22 21.3"/></svg>;
        const IconChevronUp = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>;
        const IconChevronDown = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>;

        // --- GEOGRAFISCHE ENGINE ---
        const BOUNDS = { minLon: 5.866, maxLon: 15.041, minLat: 47.270, maxLat: 55.058 };

        const project = (lat, lon) => {
            const width = 1000;
            const height = 1300; 
            const x = (lon - BOUNDS.minLon) / (BOUNDS.maxLon - BOUNDS.minLon);
            const y = 1 - (lat - BOUNDS.minLat) / (BOUNDS.maxLat - BOUNDS.minLat); 
            const padding = 50;
            return {
                x: padding + x * (width - 2 * padding),
                y: padding + y * (height - 2 * padding) * 0.9 
            };
        };

        // --- DATEN ---
        const BORDER_POINTS = [
            { lat: 55.05, lon: 8.40 }, { lat: 54.85, lon: 8.30 }, { lat: 54.80, lon: 8.65 }, { lat: 54.90, lon: 8.80 },
            { lat: 54.80, lon: 9.40 }, { lat: 54.83, lon: 9.70 }, { lat: 54.40, lon: 10.00 }, { lat: 54.45, lon: 11.20 },
            { lat: 54.20, lon: 11.00 }, { lat: 53.95, lon: 14.20 }, { lat: 53.20, lon: 14.40 }, { lat: 52.85, lon: 14.15 },
            { lat: 52.58, lon: 14.65 }, { lat: 52.35, lon: 14.55 }, { lat: 52.05, lon: 14.75 }, { lat: 51.70, lon: 14.65 },
            { lat: 51.40, lon: 15.00 }, { lat: 51.15, lon: 15.00 }, { lat: 50.90, lon: 14.95 }, { lat: 50.90, lon: 14.30 },
            { lat: 50.73, lon: 13.75 }, { lat: 50.55, lon: 13.00 }, { lat: 50.30, lon: 12.15 }, { lat: 50.05, lon: 12.20 },
            { lat: 49.65, lon: 12.50 }, { lat: 49.30, lon: 12.70 }, { lat: 49.10, lon: 13.10 }, { lat: 48.70, lon: 13.80 },
            { lat: 48.57, lon: 13.48 }, { lat: 48.25, lon: 13.00 }, { lat: 47.90, lon: 12.90 }, { lat: 47.60, lon: 13.00 },
            { lat: 47.65, lon: 12.20 }, { lat: 47.40, lon: 11.30 }, { lat: 47.42, lon: 11.00 }, { lat: 47.55, lon: 10.70 },
            { lat: 47.27, lon: 10.27 }, { lat: 47.55, lon: 9.70 }, { lat: 47.66, lon: 9.18 }, { lat: 47.60, lon: 8.60 },
            { lat: 47.58, lon: 8.20 }, { lat: 47.55, lon: 7.60 }, { lat: 47.80, lon: 7.55 }, { lat: 48.10, lon: 7.60 },
            { lat: 48.50, lon: 7.80 }, { lat: 49.00, lon: 8.15 }, { lat: 49.15, lon: 7.80 }, { lat: 49.20, lon: 7.00 },
            { lat: 49.45, lon: 6.37 }, { lat: 49.80, lon: 6.40 }, { lat: 50.15, lon: 6.15 }, { lat: 50.55, lon: 6.25 },
            { lat: 50.75, lon: 6.05 }, { lat: 51.05, lon: 5.87 }, { lat: 51.30, lon: 6.15 }, { lat: 51.83, lon: 6.25 },
            { lat: 52.20, lon: 7.00 }, { lat: 52.80, lon: 7.00 }, { lat: 53.20, lon: 7.20 }, { lat: 53.55, lon: 6.80 },
            { lat: 53.70, lon: 7.50 }, { lat: 53.80, lon: 8.00 }, { lat: 53.90, lon: 8.70 }, { lat: 54.10, lon: 8.90 }
        ];

        const CITIES = {
            "Flensburg": { lat: 54.78, lon: 9.43 }, "Görlitz": { lat: 51.15, lon: 14.98 }, "Oberstdorf": { lat: 47.40, lon: 10.27 }, "Aachen": { lat: 50.77, lon: 6.08 },
            "Passau": { lat: 48.56, lon: 13.43 }, "Basel": { lat: 47.55, lon: 7.59 }, "Saarbrücken": { lat: 49.23, lon: 6.99 }, "Frankfurt (Oder)": { lat: 52.35, lon: 14.55 },
            "Emmerich": { lat: 51.83, lon: 6.24 }, "Konstanz": { lat: 47.66, lon: 9.17 }, "Hamburg": { lat: 53.55, lon: 9.99 }, "Berlin": { lat: 52.52, lon: 13.40 },
            "München": { lat: 48.13, lon: 11.58 }, "Köln": { lat: 50.93, lon: 6.96 }, "Frankfurt": { lat: 50.11, lon: 8.68 }, "Stuttgart": { lat: 48.77, lon: 9.18 },
            "Leipzig": { lat: 51.33, lon: 12.37 }, "Dortmund": { lat: 51.51, lon: 7.46 }, "Hannover": { lat: 52.37, lon: 9.73 }, "Nürnberg": { lat: 49.45, lon: 11.07 },
            "Bremen": { lat: 53.07, lon: 8.80 }, "Dresden": { lat: 51.05, lon: 13.73 }, "Kassel": { lat: 51.31, lon: 9.48 }, "Würzburg": { lat: 49.79, lon: 9.95 },
            "Karlsruhe": { lat: 49.00, lon: 8.40 }, "Freiburg": { lat: 47.99, lon: 7.84 }, "Rostock": { lat: 54.09, lon: 12.12 }, "Magdeburg": { lat: 52.12, lon: 11.62 },
            "Erfurt": { lat: 50.98, lon: 11.02 }, "Mannheim": { lat: 49.48, lon: 8.46 }, "Ulm": { lat: 48.40, lon: 9.99 }, "Regensburg": { lat: 49.01, lon: 12.10 },
            "Lübeck": { lat: 53.86, lon: 10.68 }, "Osnabrück": { lat: 52.27, lon: 8.04 }, "Münster": { lat: 51.96, lon: 7.62 }, "Oberhausen": { lat: 51.47, lon: 6.85 },
            "Hof": { lat: 50.31, lon: 11.91 }, "Chemnitz": { lat: 50.82, lon: 12.92 }, "Bielefeld": { lat: 52.03, lon: 8.53 }, "Düsseldorf": { lat: 51.22, lon: 6.77 },
            "Duisburg": { lat: 51.43, lon: 6.76 }, "Wuppertal": { lat: 51.25, lon: 7.15 }, "Braunschweig": { lat: 52.26, lon: 10.52 }, "Augsburg": { lat: 48.37, lon: 10.89 },
            "Ingolstadt": { lat: 48.76, lon: 11.42 }, "Heidelberg": { lat: 49.39, lon: 8.67 }, "Darmstadt": { lat: 49.87, lon: 8.65 }, "Göttingen": { lat: 51.54, lon: 9.93 },
            "Heilbronn": { lat: 49.14, lon: 9.21 }, "Halle (Saale)": { lat: 51.48, lon: 11.97 }, "Jena": { lat: 50.92, lon: 11.58 }, "Kaiserslautern": { lat: 49.44, lon: 7.76 },
            "Bayreuth": { lat: 49.94, lon: 11.57 }, "Leverkusen": { lat: 51.04, lon: 6.98 }, "Wolfsburg": { lat: 52.42, lon: 10.78 }, "Trier": { lat: 49.75, lon: 6.63 },
            "Kiel": { lat: 54.32, lon: 10.12 }, "Schwerin": { lat: 53.63, lon: 11.40 }, "Eisenach": { lat: 50.97, lon: 10.31 }, "Bad Hersfeld": { lat: 50.87, lon: 9.70 },
            "Gießen": { lat: 50.58, lon: 8.67 }, "Siegen": { lat: 50.87, lon: 8.02 }, "Koblenz": { lat: 50.36, lon: 7.59 }, "Limburg": { lat: 50.38, lon: 8.06 },
            "Neumünster": { lat: 54.07, lon: 9.98 }, "Wittstock": { lat: 53.16, lon: 12.48 }, "Potsdam": { lat: 52.39, lon: 13.06 }, "Pforzheim": { lat: 48.89, lon: 8.70 },
            "Mainz": { lat: 49.99, lon: 8.24 }, "Wiesbaden": { lat: 50.07, lon: 8.23 }, "Salzburg": { lat: 47.80, lon: 13.05 }, "Waidhaus": { lat: 49.642, lon: 12.494 },
            "Heiligenhafen": { lat: 54.371, lon: 10.981 }, "Hattenbach": { lat: 50.80, lon: 9.56 }, "Füssen": { lat: 47.569, lon: 10.700 }
        };

        const INTERCHANGES = [
            { name: "Kamener Kreuz", abs: ["A1", "A2"] },
            { name: "Kreuz Leverkusen", abs: ["A1", "A3"] },
            { name: "Frankfurter Kreuz", abs: ["A3", "A5"] },
            { name: "Walldorfer Kreuz", abs: ["A5", "A6"] },
            { name: "Kreuz Weinsberg", abs: ["A6", "A81"] },
            { name: "Kreuz Feuchtwangen/Crailsheim", abs: ["A6", "A7"] },
            { name: "Kreuz Biebelried", abs: ["A3", "A7"] },
            { name: "Hermsdorfer Kreuz", abs: ["A4", "A9"] },
            { name: "Kirchheimer Dreieck", abs: ["A4", "A7"] },
            { name: "Hattenbacher Dreieck", abs: ["A5", "A7"] },
            { name: "Kreuz Oberhausen", abs: ["A2", "A3"] },
            { name: "Schkeuditzer Kreuz", abs: ["A9", "A14"] },
            { name: "Kreuz Nürnberg", abs: ["A3", "A9"] },
            { name: "Dreieck Dernbach", abs: ["A3", "A48"] }
        ];

        const AUTOBAHNEN_DEF = [
            { id: "A1", path: ["Heiligenhafen", "Lübeck", "Hamburg", "Bremen", "Osnabrück", "Münster", "Dortmund", "Wuppertal", "Leverkusen", "Köln", "Saarbrücken"], waypoints: [] },
            { id: "A2", path: ["Oberhausen", "Duisburg", "Dortmund", "Bielefeld", "Hannover", "Braunschweig", "Magdeburg", "Berlin"], waypoints: [] },
            { id: "A3", path: ["Emmerich", "Oberhausen", "Duisburg", "Düsseldorf", "Leverkusen", "Köln", "Limburg", "Frankfurt", "Würzburg", "Nürnberg", "Regensburg", "Passau"], waypoints: [{lat: 50.4, lon: 7.8}] },
            { id: "A4", path: ["Aachen", "Köln", "Eisenach", "Erfurt", "Jena", "Chemnitz", "Dresden", "Görlitz"], waypoints: [{lat: 50.9, lon: 9.7}] },
            { id: "A5", path: ["Hattenbach", "Frankfurt", "Darmstadt", "Heidelberg", "Karlsruhe", "Freiburg", "Basel"], waypoints: [] },
            { id: "A6", path: ["Saarbrücken", "Kaiserslautern", "Mannheim", "Heilbronn", "Nürnberg", "Waidhaus"], waypoints: [] },
            { id: "A7", path: ["Flensburg", "Neumünster", "Hamburg", "Hannover", "Göttingen", "Kassel", "Würzburg", "Ulm", "Füssen"], waypoints: [{lat: 50.5, lon: 9.7}] },
            { id: "A8", path: ["Karlsruhe", "Pforzheim", "Stuttgart", "Ulm", "Augsburg", "München", "Salzburg"], waypoints: [] },
            { id: "A9", path: ["Berlin", "Potsdam", "Halle (Saale)", "Leipzig", "Hof", "Bayreuth", "Nürnberg", "Ingolstadt", "München"], waypoints: [] }
        ];

        const EXAM_SCENARIOS = [
            { name: "Wolfsburg nach Regensburg", start: "Wolfsburg", end: "Regensburg", correctOrder: ["Braunschweig", "Magdeburg", "Halle (Saale)", "Leipzig", "Hof", "Bayreuth"], pool: ["Braunschweig", "Magdeburg", "Halle (Saale)", "Leipzig", "Hof", "Bayreuth", "Hannover", "Kassel", "Stuttgart", "Frankfurt", "Dortmund", "Bremen", "Erfurt", "Göttingen"], autobahnen: ["A39", "A2", "A14", "A9", "A93"] },
            { name: "Köln nach Berlin", start: "Köln", end: "Berlin", correctOrder: ["Wuppertal", "Dortmund", "Bielefeld", "Hannover", "Braunschweig", "Magdeburg"], pool: ["Wuppertal", "Dortmund", "Bielefeld", "Hannover", "Braunschweig", "Magdeburg", "Frankfurt", "Kassel", "Leipzig", "München", "Hamburg", "Bremen", "Düsseldorf", "Göttingen"], autobahnen: ["A1", "A2"] },
            { name: "Hamburg nach Basel", start: "Hamburg", end: "Basel", correctOrder: ["Hannover", "Göttingen", "Kassel", "Frankfurt", "Darmstadt", "Heidelberg", "Karlsruhe", "Freiburg"], pool: ["Hannover", "Göttingen", "Kassel", "Frankfurt", "Darmstadt", "Heidelberg", "Karlsruhe", "Freiburg", "Dortmund", "Köln", "Stuttgart", "Nürnberg", "Würzburg", "Mainz", "Mannheim"], autobahnen: ["A7", "A5"] },
            { name: "Saarbrücken nach Dresden", start: "Saarbrücken", end: "Dresden", correctOrder: ["Kaiserslautern", "Mannheim", "Heilbronn", "Nürnberg", "Bayreuth", "Hof", "Chemnitz"], pool: ["Kaiserslautern", "Mannheim", "Heilbronn", "Nürnberg", "Bayreuth", "Hof", "Chemnitz", "Frankfurt", "Stuttgart", "München", "Leipzig", "Erfurt", "Würzburg", "Regensburg"], autobahnen: ["A6", "A9", "A72", "A4"] },
            { name: "München nach Hamburg", start: "München", end: "Hamburg", correctOrder: ["Ingolstadt", "Nürnberg", "Würzburg", "Kassel", "Göttingen", "Hannover"], pool: ["Ingolstadt", "Nürnberg", "Würzburg", "Kassel", "Göttingen", "Hannover", "Stuttgart", "Frankfurt", "Leipzig", "Dortmund", "Magdeburg", "Bremen"], autobahnen: ["A9", "A3", "A7"] },
            { name: "Stuttgart nach Berlin", start: "Stuttgart", end: "Berlin", correctOrder: ["Heilbronn", "Nürnberg", "Bayreuth", "Hof", "Leipzig", "Potsdam"], pool: ["Heilbronn", "Nürnberg", "Bayreuth", "Hof", "Leipzig", "Potsdam", "Frankfurt", "Kassel", "Hannover", "München", "Dresden", "Erfurt"], autobahnen: ["A81", "A6", "A9"] },
            { name: "Köln nach Frankfurt", start: "Köln", end: "Frankfurt", correctOrder: ["Leverkusen", "Limburg", "Wiesbaden"], pool: ["Leverkusen", "Limburg", "Wiesbaden", "Dortmund", "Kassel", "Mannheim", "Heidelberg", "Bonn", "Aachen"], autobahnen: ["A3"] },
            { name: "Dortmund nach Stuttgart", start: "Dortmund", end: "Stuttgart", correctOrder: ["Siegen", "Gießen", "Frankfurt", "Darmstadt", "Heidelberg", "Heilbronn"], pool: ["Siegen", "Gießen", "Frankfurt", "Darmstadt", "Heidelberg", "Heilbronn", "Kassel", "Hannover", "Nürnberg", "München", "Köln", "Würzburg"], autobahnen: ["A45", "A5", "A6", "A81"] },
            { name: "Leipzig nach Köln", start: "Leipzig", end: "Köln", correctOrder: ["Erfurt", "Eisenach", "Bad Hersfeld", "Gießen", "Siegen"], pool: ["Erfurt", "Eisenach", "Bad Hersfeld", "Gießen", "Siegen", "Hannover", "Nürnberg", "Würzburg", "Stuttgart", "Dortmund", "Bielefeld"], autobahnen: ["A4", "A5", "A45", "A4"] },
            { name: "Bremen nach München", start: "Bremen", end: "München", correctOrder: ["Hannover", "Göttingen", "Kassel", "Würzburg", "Nürnberg", "Ingolstadt"], pool: ["Hannover", "Göttingen", "Kassel", "Würzburg", "Nürnberg", "Ingolstadt", "Dortmund", "Frankfurt", "Leipzig", "Stuttgart", "Mannheim", "Köln"], autobahnen: ["A27", "A7", "A3", "A9"] },
            { name: "Saarbrücken nach Berlin", start: "Saarbrücken", end: "Berlin", correctOrder: ["Kaiserslautern", "Mannheim", "Frankfurt", "Bad Hersfeld", "Eisenach", "Erfurt", "Leipzig"], pool: ["Kaiserslautern", "Mannheim", "Frankfurt", "Bad Hersfeld", "Eisenach", "Erfurt", "Leipzig", "Stuttgart", "Nürnberg", "Hannover", "Dortmund", "Kassel"], autobahnen: ["A6", "A67", "A5", "A4", "A9"] },
            { name: "Nürnberg nach Dortmund", start: "Nürnberg", end: "Dortmund", correctOrder: ["Würzburg", "Frankfurt", "Gießen", "Siegen"], pool: ["Würzburg", "Frankfurt", "Gießen", "Siegen", "Stuttgart", "Mannheim", "Kassel", "Erfurt", "Hannover", "Leipzig"], autobahnen: ["A3", "A45"] },
            { name: "Basel nach Köln", start: "Basel", end: "Köln", correctOrder: ["Freiburg", "Karlsruhe", "Heidelberg", "Darmstadt", "Frankfurt", "Limburg"], pool: ["Freiburg", "Karlsruhe", "Heidelberg", "Darmstadt", "Frankfurt", "Limburg", "Stuttgart", "Nürnberg", "Würzburg", "Kassel", "Saarbrücken", "Trier"], autobahnen: ["A5", "A3"] },
            { name: "Dresden nach München", start: "Dresden", end: "München", correctOrder: ["Chemnitz", "Hof", "Bayreuth", "Nürnberg", "Ingolstadt"], pool: ["Chemnitz", "Hof", "Bayreuth", "Nürnberg", "Ingolstadt", "Leipzig", "Erfurt", "Würzburg", "Stuttgart", "Passau", "Augsburg"], autobahnen: ["A4", "A72", "A9"] },
            { name: "Kiel nach Hannover", start: "Kiel", end: "Hannover", correctOrder: ["Neumünster", "Hamburg"], pool: ["Neumünster", "Hamburg", "Bremen", "Lübeck", "Rostock", "Schwerin", "Osnabrück", "Münster"], autobahnen: ["A7"] },
            { name: "Konstanz nach Frankfurt", start: "Konstanz", end: "Frankfurt", correctOrder: ["Stuttgart", "Heilbronn", "Heidelberg", "Darmstadt"], pool: ["Stuttgart", "Heilbronn", "Heidelberg", "Darmstadt", "Freiburg", "Basel", "München", "Nürnberg", "Würzburg", "Ulm"], autobahnen: ["A81", "A6", "A5"] },
            { name: "Trier nach Frankfurt", start: "Trier", end: "Frankfurt", correctOrder: ["Koblenz", "Limburg", "Wiesbaden"], pool: ["Koblenz", "Limburg", "Wiesbaden", "Saarbrücken", "Kaiserslautern", "Mannheim", "Köln", "Bonn", "Aachen"], autobahnen: ["A48", "A3"] },
            { name: "Rostock nach Berlin", start: "Rostock", end: "Berlin", correctOrder: ["Wittstock"], pool: ["Wittstock", "Schwerin", "Hamburg", "Lübeck", "Magdeburg", "Hannover", "Leipzig"], autobahnen: ["A19", "A24"] },
            { name: "Osnabrück nach Passau", start: "Osnabrück", end: "Passau", correctOrder: ["Bielefeld", "Kassel", "Würzburg", "Nürnberg", "Regensburg"], pool: ["Bielefeld", "Kassel", "Würzburg", "Nürnberg", "Regensburg", "Hannover", "Dortmund", "Frankfurt", "Stuttgart", "München", "Leipzig"], autobahnen: ["A33", "A44", "A7", "A3"] },
            { name: "Emmerich nach Basel", start: "Emmerich", end: "Basel", correctOrder: ["Oberhausen", "Duisburg", "Düsseldorf", "Köln", "Frankfurt", "Karlsruhe", "Freiburg"], pool: ["Oberhausen", "Duisburg", "Düsseldorf", "Köln", "Frankfurt", "Karlsruhe", "Freiburg", "Münster", "Dortmund", "Bremen", "Kassel", "Stuttgart", "Nürnberg"], autobahnen: ["A3", "A67", "A5"] }
        ];
        
        const NAVI_ROUTES = [
            { name: "Regensburg nach Wolfsburg", start: "Regensburg", end: "Wolfsburg", stops: ["Regensburg", "Hof", "Leipzig", "Magdeburg", "Braunschweig", "Wolfsburg"] },
            { name: "Köln nach Berlin", start: "Köln", end: "Berlin", stops: ["Köln", "Wuppertal", "Dortmund", "Bielefeld", "Hannover", "Magdeburg", "Berlin"] },
            { name: "Frankfurt nach München", start: "Frankfurt", end: "München", stops: ["Frankfurt", "Würzburg", "Nürnberg", "Ingolstadt", "München"] },
            { name: "Hamburg nach Basel", start: "Hamburg", end: "Basel", stops: ["Hamburg", "Hannover", "Göttingen", "Kassel", "Frankfurt", "Darmstadt", "Karlsruhe", "Freiburg", "Basel"] }
        ];

        // Helper Functions
        const getDistance = (p1, p2) => Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2));

        const getMinDistToPolyline = (p, polylinePoints) => {
            let minDist = Infinity;
            for (let i = 0; i < polylinePoints.length - 1; i++) {
                const a = polylinePoints[i];
                const b = polylinePoints[i+1];
                const atob = { x: b.x - a.x, y: b.y - a.y };
                const atop = { x: p.x - a.x, y: p.y - a.y };
                const len = atob.x * atob.x + atob.y * atob.y;
                let dot = atop.x * atob.x + atop.y * atob.y;
                let t = Math.min(1, Math.max(0, dot / len));
                const closest = { x: a.x + atob.x * t, y: a.y + atob.y * t };
                const dist = getDistance(p, closest);
                if (dist < minDist) minDist = dist;
            }
            return minDist;
        };

        function AutobahnGame() {
        const [gameState, setGameState] = useState('menu');
        const [gameMode, setGameMode] = useState('classic');
        const [currentRound, setCurrentRound] = useState(0);
        const [score, setScore] = useState(0);
        const [tasks, setTasks] = useState([]);
        const [currentTask, setCurrentTask] = useState(null);
        const [userMarkers, setUserMarkers] = useState([]); 
        const [examPool, setExamPool] = useState([]);
        const [examSelection, setExamSelection] = useState([]);
        const [resultInfo, setResultInfo] = useState(null);
        const svgRef = useRef(null);

        const germanyPath = useMemo(() => {
            const points = BORDER_POINTS.map(p => project(p.lat, p.lon));
            if (points.length === 0) return "";
            let d = `M${points[0].x},${points[0].y} `;
            for (let i = 1; i < points.length; i++) {
                d += `L${points[i].x},${points[i].y} `;
            }
            d += "Z";
            return d;
        }, []);

        const autobahnPolylines = useMemo(() => {
            return AUTOBAHNEN_DEF.map(a => {
                const allNodes = a.path.map(name => CITIES[name]).filter(Boolean);
                const points = allNodes.map(node => project(node.lat, node.lon));
                return { id: a.id, points, path: a.path };
            });
        }, []);

        const startGame = (mode) => {
            setGameMode(mode);
            // Score wird NICHT zurückgesetzt für Langzeitmotivation
            setCurrentRound(1);
            setUserMarkers([]);
            setExamSelection([]);
            setExamPool([]);
            setResultInfo(null);
            
            let newTasks = [];
            
            if (mode === 'classic') {
                const shuffledIds = [...AUTOBAHNEN_DEF].sort(() => 0.5 - Math.random());
                newTasks = shuffledIds.slice(0, 5).map(a => ({
                    type: 'autobahn',
                    targetId: a.id,
                    prompt: `Wo verläuft die ${a.id}?`,
                    subPrompt: "Klicke den Verlauf der Strecke nach."
                }));
            } else if (mode === 'cities') {
                const shuffledIds = [...AUTOBAHNEN_DEF].sort(() => 0.5 - Math.random());
                shuffledIds.slice(0, 5).forEach(a => {
                    const cityNames = a.path.filter(name => CITIES[name]);
                    if(cityNames.length > 0) {
                        const city = cityNames[Math.floor(Math.random() * cityNames.length)];
                        newTasks.push({
                            type: 'city',
                            targetCity: city,
                            targetAutobahnId: a.id,
                            prompt: `Finde ${city}`,
                            subPrompt: `Gelegen an der ${a.id}.`
                        });
                    }
                });
            } else if (mode === 'navigation') {
                const shuffledRoutes = [...NAVI_ROUTES].sort(() => 0.5 - Math.random());
                newTasks = shuffledRoutes.slice(0, 3).map(r => ({
                    type: 'navigation',
                    route: r,
                    prompt: `Navi: ${r.name}`,
                    subPrompt: `Plane die Route von ${r.start} nach ${r.end}.`
                }));
            } else if (mode === 'exam') {
                const shuffledExams = [...EXAM_SCENARIOS].sort(() => 0.5 - Math.random());
                newTasks = shuffledExams.slice(0, 3).map(e => ({
                    type: 'exam',
                    scenario: e,
                    prompt: `Prüfung: ${e.name}`,
                    subPrompt: "Bringe die Orte in die richtige Reihenfolge."
                }));
                // Init Pool
                const firstTask = newTasks[0];
                setExamPool([...firstTask.scenario.pool].sort(() => 0.5 - Math.random()));
                setExamSelection([]);
            } else if (mode === 'interchanges') {
                // Neue Interchanges Logik
                const shuffled = [...INTERCHANGES].sort(() => 0.5 - Math.random()).slice(0, 5);
                newTasks = shuffled.map(kreuz => {
                    // 50/50 Chance für Fragetyp
                    const type = Math.random() > 0.5 ? 'name_to_abs' : 'abs_to_name';
                    
                    // Distraktoren generieren
                    let options = [];
                    let question = "";
                    let correctAnswer = "";

                    if (type === 'name_to_abs') {
                        question = `Welche Autobahnen kreuzen sich am ${kreuz.name}?`;
                        correctAnswer = kreuz.abs.join(" / ");
                        
                        // Falsche Antworten generieren (andere AB Paare)
                        const others = INTERCHANGES.filter(k => k.name !== kreuz.name);
                        const wrongs = others.sort(() => 0.5 - Math.random()).slice(0, 3).map(k => k.abs.join(" / "));
                        options = [correctAnswer, ...wrongs].sort(() => 0.5 - Math.random());
                    } else {
                        question = `Wo kreuzen sich die ${kreuz.abs.join(" und ")}?`;
                        correctAnswer = kreuz.name;
                        
                        const others = INTERCHANGES.filter(k => k.name !== kreuz.name);
                        const wrongs = others.sort(() => 0.5 - Math.random()).slice(0, 3).map(k => k.name);
                        options = [correctAnswer, ...wrongs].sort(() => 0.5 - Math.random());
                    }

                    return {
                        type: 'interchange_quiz',
                        question,
                        options,
                        correctAnswer,
                        kreuz // Ref für Map
                    };
                });
            }
            
            setTasks(newTasks);
            setCurrentTask(newTasks[0]);
            setGameState('playing');
        };

        const handleExamSelect = (city) => {
            setExamPool(prev => prev.filter(c => c !== city));
            setExamSelection(prev => [...prev, city]);
        };

        const handleExamDeselect = (city) => {
            setExamSelection(prev => prev.filter(c => c !== city));
            setExamPool(prev => [...prev, city].sort());
        };

        const moveExamItem = (idx, direction) => {
            const newSelection = [...examSelection];
            const item = newSelection[idx];
            newSelection.splice(idx, 1);
            newSelection.splice(idx + direction, 0, item);
            setExamSelection(newSelection);
        };

        const handleMapClick = (e) => {
            if (gameState !== 'playing' || !svgRef.current || gameMode === 'exam' || gameMode === 'interchanges') return;

            const rect = svgRef.current.getBoundingClientRect();
            const scaleX = 1000 / rect.width;
            const scaleY = 1300 / rect.height;
            
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            const newPoint = { x, y };

            if (gameMode === 'cities') {
                setUserMarkers([newPoint]);
                evaluateRound([newPoint]);
            } else {
                setUserMarkers(prev => [...prev, newPoint]);
            }
        };

        const handleInterchangeAnswer = (answer) => {
            const isCorrect = answer === currentTask.correctAnswer;
            const points = isCorrect ? 100 : 0;
            setScore(prev => prev + points);
            setResultInfo({
                points,
                feedbackText: isCorrect ? "Richtig!" : `Falsch. Richtig wäre: ${currentTask.correctAnswer}`,
                interchange: currentTask.kreuz,
                userAnswer: answer
            });
            setGameState('roundResult');
        };

        const manualEvaluate = () => {
            if (gameMode === 'exam') {
                evaluateExamRound();
            } else {
                if (userMarkers.length === 0) return;
                evaluateRound(userMarkers);
            }
        };

        const undoLastMarker = (e) => {
            e.stopPropagation();
            setUserMarkers(prev => prev.slice(0, -1));
        };

        const evaluateExamRound = () => {
            const correctOrder = currentTask.scenario.correctOrder;
            const userOrder = examSelection;
            let points = 0;
            
            userOrder.forEach((city, index) => {
                if (correctOrder.includes(city)) {
                    points += 10; 
                    if (correctOrder[index] === city) {
                        points += 10; 
                    }
                } else {
                    points -= 5; 
                }
            });
            
            const maxPoints = correctOrder.length * 20;
            points = Math.max(0, Math.round((points / maxPoints) * 100));
            let feedbackText = points > 90 ? "Perfekt!" : points > 60 ? "Gut gelöst." : "Das musst du üben.";

            const targetPolylinePoints = [
                currentTask.scenario.start, 
                ...currentTask.scenario.correctOrder, 
                currentTask.scenario.end
            ].map(name => CITIES[name]).filter(Boolean).map(c => project(c.lat, c.lon));

            setScore(prev => prev + points);
            setResultInfo({
                points,
                feedbackText,
                targetPolylinePoints,
                targetId: null,
                examData: {
                    userSelection: userOrder,
                    correctOrder: correctOrder,
                    autobahnen: currentTask.scenario.autobahnen
                }
            });
            setGameState('roundResult');
        };

        const evaluateRound = (markers) => {
            let distance = 0;
            let points = 0;
            let targetPolylinePoints = [];

            if (currentTask.type === 'autobahn') {
                const ab = autobahnPolylines.find(a => a.id === currentTask.targetId);
                targetPolylinePoints = ab.points;
                let totalDist = 0;
                markers.forEach(m => {
                    totalDist += getMinDistToPolyline(m, targetPolylinePoints);
                });
                distance = totalDist / markers.length;

            } else if (currentTask.type === 'city') {
                const city = CITIES[currentTask.targetCity];
                const p = project(city.lat, city.lon);
                targetPolylinePoints = [p];
                distance = getDistance(markers[0], p);

            } else if (currentTask.type === 'navigation') {
                const stops = currentTask.route.stops.map(name => CITIES[name]).filter(Boolean);
                targetPolylinePoints = stops.map(s => project(s.lat, s.lon));
                let totalDist = 0;
                markers.forEach(m => {
                    totalDist += getMinDistToPolyline(m, targetPolylinePoints);
                });
                distance = totalDist / markers.length;
            }

            if (distance < 40) points = 100;
            else if (distance > 300) points = 0;
            else points = Math.round(100 * (1 - (distance - 40) / 260));

            let feedbackText = points > 80 ? "Ausgezeichnet!" : points > 50 ? "Gut gemacht." : "Das geht genauer.";

            setScore(prev => prev + points);
            setResultInfo({
                distance,
                points,
                feedbackText,
                targetPolylinePoints,
                targetId: currentTask.type === 'autobahn' ? currentTask.targetId : null
            });
            setGameState('roundResult');
        };

        const nextRound = () => {
            if (currentRound >= tasks.length) {
                setGameState('gameOver');
            } else {
                const nextIdx = currentRound;
                setCurrentRound(prev => prev + 1);
                setCurrentTask(tasks[nextIdx]);
                
                if (tasks[nextIdx].type === 'exam') {
                    setExamPool([...tasks[nextIdx].scenario.pool].sort(() => 0.5 - Math.random()));
                    setExamSelection([]);
                }

                setUserMarkers([]);
                setResultInfo(null);
                setGameState('playing');
            }
        };

        return (
            <div className="min-h-screen bg-stone-50 text-stone-800 font-sans flex flex-col h-screen overflow-hidden">
                <header className="bg-stone-900 text-stone-100 p-3 shadow-md z-10 shrink-0">
                    <div className="max-w-4xl mx-auto flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <IconMap className="w-6 h-6 text-amber-500" />
                            <h1 className="text-lg font-bold tracking-wider uppercase">Autobahn<span className="text-amber-500">Meister</span></h1>
                        </div>
                        
                        <div className="flex items-center gap-4">
                            {gameState !== 'menu' && (
                                <div className="flex items-center gap-4 bg-stone-800 px-4 py-1 rounded-full border border-stone-700">
                                    <span className="text-xs text-stone-400 uppercase tracking-widest">Runde {currentRound}/{tasks.length}</span>
                                    <div className="flex items-center gap-1 font-bold text-amber-400">
                                        <IconTrophy className="w-4 h-4" />
                                        <span>{score}</span>
                                    </div>
                                </div>
                            )}
                            
                            {/* Close / Abort Button */}
                            {gameState !== 'menu' && (
                                <button 
                                    onClick={() => setGameState('menu')}
                                    className="p-2 rounded-full bg-stone-800 text-stone-400 hover:bg-red-600 hover:text-white transition-colors border border-stone-700"
                                    title="Spiel abbrechen"
                                >
                                    <IconX className="w-5 h-5" />
                                </button>
                            )}
                        </div>
                    </div>
                </header>

                <main className="flex-1 relative overflow-hidden flex flex-col">
                    {gameState === 'menu' && (
                        <div className="absolute inset-0 z-20 bg-stone-100 flex flex-col items-center justify-center p-4 overflow-y-auto">
                            <div className="max-w-2xl w-full space-y-8 py-8">
                                <div className="text-center space-y-4">
                                    <div className="inline-block p-4 bg-white rounded-full shadow-xl mb-4">
                                        <IconMap className="w-16 h-16 text-stone-800" />
                                    </div>
                                    <h2 className="text-4xl font-black text-stone-800">Deutschland Karte</h2>
                                    <p className="text-stone-500 text-lg">Lerne Routen, Städte und Autobahnen.</p>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <button onClick={() => startGame('classic')} className="group p-6 bg-white rounded-2xl shadow-sm hover:shadow-xl border-2 border-transparent hover:border-amber-400 transition-all text-left">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-bold text-xl">Autobahn Verlauf</span>
                                            <IconNavigation className="w-6 h-6 text-stone-400 group-hover:text-amber-500" />
                                        </div>
                                        <p className="text-stone-500 text-sm">Zeichne den Verlauf von A1 bis A9.</p>
                                    </button>
                                    <button onClick={() => startGame('cities')} className="group p-6 bg-white rounded-2xl shadow-sm hover:shadow-xl border-2 border-transparent hover:border-amber-400 transition-all text-left">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-bold text-xl">Städte finden</span>
                                            <IconMapPin className="w-6 h-6 text-stone-400 group-hover:text-amber-500" />
                                        </div>
                                        <p className="text-stone-500 text-sm">Finde Städte entlang der Autobahnen.</p>
                                    </button>
                                    <button onClick={() => startGame('navigation')} className="group p-6 bg-white rounded-2xl shadow-sm hover:shadow-xl border-2 border-transparent hover:border-amber-400 transition-all text-left">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-bold text-xl">Navi Challenge</span>
                                            <IconFlag className="w-6 h-6 text-stone-400 group-hover:text-amber-500" />
                                        </div>
                                        <p className="text-stone-500 text-sm">Plane Routen auf der Karte.</p>
                                    </button>
                                    <button onClick={() => startGame('interchanges')} className="group p-6 bg-white rounded-2xl shadow-sm hover:shadow-xl border-2 border-transparent hover:border-amber-400 transition-all text-left">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-bold text-xl">Autobahnkreuze</span>
                                            <IconShuffle className="w-6 h-6 text-stone-400 group-hover:text-amber-500" />
                                        </div>
                                        <p className="text-stone-500 text-sm">Welche Autobahnen treffen sich wo?</p>
                                    </button>
                                    <button onClick={() => startGame('exam')} className="group p-6 bg-stone-800 text-white rounded-2xl shadow-sm hover:shadow-xl border-2 border-transparent hover:border-amber-400 transition-all text-left md:col-span-2">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-bold text-xl">Prüfung: Route & Orte</span>
                                            <IconListOrdered className="w-6 h-6 text-amber-500" />
                                        </div>
                                        <p className="text-stone-400 text-sm">Wähle die richtigen Orte in korrekter Reihenfolge.</p>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* GAME AREA LAYOUT: MOBILE-FRIENDLY */}
                    <div className="flex-1 relative bg-[#aaccff] w-full h-full overflow-hidden flex flex-col md:flex-row">
                        
                        {/* 1. TASK HEADER (Mobile) / OVERLAY (Desktop) */}
                        {gameState === 'playing' && currentTask && gameMode !== 'exam' && gameMode !== 'interchanges' && (
                            <div className="md:absolute md:top-4 md:left-4 md:w-80 z-30 bg-white/95 backdrop-blur shadow-md border-b md:border border-stone-200 p-3 flex-shrink-0 md:rounded-xl">
                                <h3 className="text-lg font-black text-stone-800 leading-tight">{currentTask.prompt}</h3>
                                <p className="text-stone-500 text-xs mb-2">{currentTask.subPrompt}</p>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={undoLastMarker} 
                                        disabled={userMarkers.length === 0}
                                        className="flex-1 py-1.5 rounded bg-stone-100 text-stone-600 font-bold text-xs hover:bg-stone-200 disabled:opacity-50 flex items-center justify-center gap-1"
                                    >
                                        <IconUndo className="w-3 h-3" /> Undo
                                    </button>
                                    <button 
                                        onClick={manualEvaluate}
                                        disabled={userMarkers.length === 0}
                                        className="flex-1 py-1.5 rounded bg-amber-500 text-white font-bold text-xs hover:bg-amber-600 shadow-sm disabled:opacity-50 flex items-center justify-center gap-1"
                                    >
                                        Bestätigen <IconArrowRight className="w-3 h-3" />
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* 2. MAP CONTAINER */}
                        <div className={`relative flex-1 bg-white transition-all duration-500 ease-in-out overflow-hidden ${gameMode === 'exam' && gameState === 'playing' ? 'md:w-1/2 h-[40vh] md:h-full opacity-50 pointer-events-none blur-sm' : 'w-full h-full'}`}>
                            <div className="w-full h-full flex items-center justify-center bg-[#aaccff]">
                                <svg 
                                    ref={svgRef}
                                    viewBox="0 0 1000 1300" 
                                    preserveAspectRatio="xMidYMid contain"
                                    className="max-w-full max-h-full cursor-crosshair block shadow-2xl bg-white"
                                    onClick={handleMapClick}
                                >
                                    <rect width="1000" height="1300" fill="#aaccff" />
                                    <path d={germanyPath} fill="#f5f5f4" stroke="#78716c" strokeWidth="2" />

                                    {/* INTERCHANGE MODE MAP MARKERS */}
                                    {gameState === 'playing' && currentTask.type === 'interchange_quiz' && currentTask.kreuz.abs.map((abName, idx) => {
                                        const ab = AUTOBAHNEN_DEF.find(a => a.id === abName);
                                        if(!ab) return null;
                                        const points = autobahnPolylines.find(p => p.id === abName)?.points || [];
                                        return (
                                            <polyline 
                                                key={abName}
                                                points={points.map(p => `${p.x},${p.y}`).join(' ')}
                                                fill="none"
                                                stroke="#94a3b8"
                                                strokeWidth="4"
                                                opacity="0.4"
                                            />
                                        )
                                    })}

                                    {/* EXAM RESULT OVERLAY */}
                                    {resultInfo && resultInfo.examData && (
                                        <g>
                                            <polyline 
                                                points={resultInfo.targetPolylinePoints.map(p => `${p.x},${p.y}`).join(' ')}
                                                fill="none"
                                                stroke="#3b82f6"
                                                strokeWidth="6"
                                                strokeLinecap="round"
                                                strokeLinejoin="round"
                                            />
                                            {resultInfo.examData.userSelection.map((city, idx) => {
                                                const c = CITIES[city];
                                                if(!c) return null;
                                                const p = project(c.lat, c.lon);
                                                const isCorrect = resultInfo.examData.correctOrder.includes(city);
                                                return (
                                                    <g key={idx}>
                                                        <circle cx={p.x} cy={p.y} r="6" fill={isCorrect ? "#10b981" : "#ef4444"} stroke="white" strokeWidth="2" />
                                                        <text x={p.x} y={p.y - 10} textAnchor="middle" fontSize="16" fontWeight="bold" fill={isCorrect ? "#10b981" : "#ef4444"}>{city}</text>
                                                    </g>
                                                );
                                            })}
                                        </g>
                                    )}

                                    {/* NORMAL OVERLAYS */}
                                    {gameState === 'playing' && currentTask && currentTask.type === 'navigation' && (
                                        <>
                                            {(() => {
                                                const start = CITIES[currentTask.route.start];
                                                const end = CITIES[currentTask.route.end];
                                                if(!start || !end) return null;
                                                const pStart = project(start.lat, start.lon);
                                                const pEnd = project(end.lat, end.lon);
                                                return (
                                                    <g>
                                                        <circle cx={pStart.x} cy={pStart.y} r="6" fill="#10b981" stroke="white" strokeWidth="2" />
                                                        <circle cx={pEnd.x} cy={pEnd.y} r="6" fill="#f43f5e" stroke="white" strokeWidth="2" />
                                                    </g>
                                                )
                                            })()}
                                        </>
                                    )}

                                    {(gameState === 'roundResult' || gameState === 'gameOver') && resultInfo && !resultInfo.examData && !resultInfo.interchange && (
                                        <g>
                                            <polyline 
                                                points={resultInfo.targetPolylinePoints.map(p => `${p.x},${p.y}`).join(' ')}
                                                fill="none"
                                                stroke={currentTask.type === 'cities' ? '#94a3b8' : '#3b82f6'}
                                                strokeWidth="6"
                                                strokeLinecap="round"
                                                strokeLinejoin="round"
                                                className={currentTask.type === 'cities' ? '' : 'animate-pulse'}
                                                opacity={currentTask.type === 'cities' ? 0.5 : 1}
                                            />
                                            {currentTask.type === 'autobahn' && AUTOBAHNEN_DEF.find(a => a.id === resultInfo.targetId).path.map(cityName => {
                                                const c = CITIES[cityName];
                                                if(!c) return null;
                                                const p = project(c.lat, c.lon);
                                                return (
                                                    <g key={cityName}>
                                                        <circle cx={p.x} cy={p.y} r="3" fill="#1e293b" />
                                                        <text x={p.x} y={p.y - 8} textAnchor="middle" fontSize="14" fontWeight="bold" fill="#334155">{cityName}</text>
                                                    </g>
                                                );
                                            })}
                                            {currentTask.type === 'city' && (() => {
                                                const c = CITIES[currentTask.targetCity];
                                                const p = project(c.lat, c.lon);
                                                return (
                                                    <g>
                                                        <circle cx={p.x} cy={p.y} r="6" fill="#10b981" stroke="white" strokeWidth="2" />
                                                        <text x={p.x} y={p.y - 12} textAnchor="middle" fontSize="18" fontWeight="bold" fill="#10b981">{currentTask.targetCity}</text>
                                                    </g>
                                                );
                                            })()}
                                        </g>
                                    )}

                                    {userMarkers.length > 0 && (
                                        <g>
                                            <polyline 
                                                points={userMarkers.map(p => `${p.x},${p.y}`).join(' ')}
                                                fill="none"
                                                stroke="#ef4444"
                                                strokeWidth="4"
                                                strokeDasharray="8,4"
                                            />
                                            {userMarkers.map((m, i) => (
                                                <circle key={i} cx={m.x} cy={m.y} r="5" fill="#ef4444" stroke="white" strokeWidth="2" />
                                            ))}
                                        </g>
                                    )}
                                </svg>
                            </div>

                            {/* RESULT OVERLAY: Desktop (Top-Right), Mobile (Bottom Fixed) */}
                            {gameState === 'roundResult' && resultInfo && (
                                <div className={`absolute z-40 w-full md:w-80 bg-white/95 backdrop-blur shadow-2xl border-t md:border-t-0 md:border border-stone-200 md:rounded-xl p-4 animate-in slide-in-from-bottom-4 md:slide-in-from-top-4
                                    bottom-0 md:bottom-auto md:top-4 md:right-4`}>
                                    
                                    <div className="flex items-center gap-3 mb-3">
                                        {resultInfo.points > 80 ? <IconCheckCircle className="w-8 h-8 text-green-500" /> : <IconTarget className="w-8 h-8 text-amber-500" />}
                                        <div className="text-left flex-1">
                                            <div className="text-[10px] uppercase font-bold text-stone-400">Ergebnis</div>
                                            <div className="text-lg font-black text-stone-800 leading-tight">{resultInfo.feedbackText}</div>
                                        </div>
                                        <div className="text-2xl font-black text-amber-500">+{resultInfo.points}</div>
                                    </div>

                                    {resultInfo.examData && (
                                        <div className="mb-3 p-2 bg-stone-50 rounded-lg border border-stone-100 text-xs">
                                            <div className="font-bold text-stone-700 mb-1">Autobahnen:</div>
                                            <div className="flex flex-wrap gap-1 mb-2">
                                                {resultInfo.examData.autobahnen.map(a => (
                                                    <span key={a} className="px-1.5 py-0.5 bg-blue-600 text-white text-[10px] rounded font-bold">{a}</span>
                                                ))}
                                            </div>
                                            <div className="font-bold text-stone-700 mb-1">Route:</div>
                                            <div className="text-stone-500 leading-snug">
                                                {resultInfo.examData.correctOrder.join(' ➔ ')}
                                            </div>
                                        </div>
                                    )}

                                    {resultInfo.interchange && (
                                        <div className="mb-3 p-2 bg-stone-50 rounded-lg border border-stone-100 text-xs">
                                            <div className="font-bold text-stone-700 mb-1">{resultInfo.interchange.name}</div>
                                            <div className="text-stone-500">{resultInfo.interchange.abs.join(' & ')}</div>
                                        </div>
                                    )}

                                    <button onClick={nextRound} className="w-full py-2.5 rounded-lg bg-stone-900 text-white font-bold hover:bg-black transition-all flex items-center justify-center gap-2 text-sm">
                                        Nächste Runde <IconPlay className="w-3 h-3" />
                                    </button>
                                </div>
                            )}

                            {/* INTERCHANGE QUIZ OVERLAY */}
                            {gameState === 'playing' && currentTask && gameMode === 'interchanges' && (
                                <div className="absolute inset-0 z-30 flex items-center justify-center p-4 bg-stone-900/20 backdrop-blur-sm">
                                    <div className="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full animate-in zoom-in-95">
                                        <h3 className="text-xl font-black text-stone-800 mb-4 text-center">{currentTask.question}</h3>
                                        <div className="grid gap-3">
                                            {currentTask.options.map((opt, idx) => (
                                                <button 
                                                    key={idx}
                                                    onClick={() => handleInterchangeAnswer(opt)}
                                                    className="p-4 rounded-lg bg-stone-100 hover:bg-amber-100 border border-stone-200 hover:border-amber-300 font-bold text-stone-700 transition-all text-left"
                                                >
                                                    {opt}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                        </div>

                        {/* EXAM UI PANEL (Right Side Desktop, Bottom Mobile) */}
                        {gameMode === 'exam' && gameState === 'playing' && (
                            <div className="flex-1 bg-stone-100 border-t md:border-t-0 md:border-l border-stone-200 shadow-2xl z-30 flex flex-col overflow-hidden h-[60vh] md:h-full">
                                <div className="p-4 bg-white border-b border-stone-200 flex-shrink-0">
                                    <h2 className="text-lg font-black text-stone-800">Prüfungssimulation</h2>
                                    <p className="text-stone-500 text-xs">Fahre von <strong className="text-stone-800">{currentTask.scenario.start}</strong> nach <strong className="text-stone-800">{currentTask.scenario.end}</strong>.</p>
                                </div>

                                <div className="flex-1 overflow-y-auto p-4 flex flex-col gap-4">
                                    {/* Selected List */}
                                    <div className="bg-white p-3 rounded-xl shadow-sm border border-stone-200 min-h-[100px]">
                                        <h3 className="text-[10px] font-bold text-stone-400 uppercase tracking-widest mb-2">Deine Route</h3>
                                        <div className="space-y-1.5">
                                            {examSelection.length === 0 && <div className="text-stone-300 italic text-center py-4 text-sm">Wähle Orte...</div>}
                                            {examSelection.map((city, idx) => (
                                                <div key={city} className="flex items-center gap-2 bg-blue-50 p-1.5 rounded-lg border border-blue-100 animate-in slide-in-from-left-2">
                                                    <div className="w-5 h-5 bg-blue-200 text-blue-700 rounded-full flex items-center justify-center text-[10px] font-bold flex-shrink-0">{idx + 1}</div>
                                                    <span className="font-medium text-stone-700 flex-1 text-sm truncate">{city}</span>
                                                    
                                                    {/* REORDER BUTTONS */}
                                                    <div className="flex flex-col">
                                                        <button 
                                                            onClick={() => idx > 0 && moveExamItem(idx, -1)} 
                                                            disabled={idx === 0}
                                                            className="text-stone-400 hover:text-stone-600 disabled:opacity-30"
                                                        >
                                                            <IconChevronUp className="w-3 h-3" />
                                                        </button>
                                                        <button 
                                                            onClick={() => idx < examSelection.length - 1 && moveExamItem(idx, 1)}
                                                            disabled={idx === examSelection.length - 1} 
                                                            className="text-stone-400 hover:text-stone-600 disabled:opacity-30"
                                                        >
                                                            <IconChevronDown className="w-3 h-3" />
                                                        </button>
                                                    </div>

                                                    <button onClick={() => handleExamDeselect(city)} className="text-stone-400 hover:text-red-500 p-1 ml-1">
                                                        <IconTrash2 className="w-3 h-3" />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Pool */}
                                    <div>
                                        <h3 className="text-[10px] font-bold text-stone-400 uppercase tracking-widest mb-2">Verfügbare Orte</h3>
                                        <div className="flex flex-wrap gap-1.5">
                                            {examPool.map(city => (
                                                <button 
                                                    key={city} 
                                                    onClick={() => handleExamSelect(city)}
                                                    className="px-2.5 py-1.5 bg-white border border-stone-200 rounded text-xs font-medium text-stone-600 hover:bg-stone-50 hover:border-stone-300 hover:shadow-sm transition-all active:bg-stone-100"
                                                >
                                                    {city}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="p-4 border-t border-stone-200 bg-white flex-shrink-0">
                                    <button 
                                        onClick={manualEvaluate}
                                        disabled={examSelection.length < 2}
                                        className="w-full py-3 rounded-xl bg-amber-500 text-white font-bold hover:bg-amber-600 shadow-lg shadow-amber-500/20 disabled:opacity-50 disabled:shadow-none flex items-center justify-center gap-2 text-sm"
                                    >
                                        Prüfung abgeben <IconArrowRight className="w-4 h-4" />
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {gameState === 'gameOver' && (
                        <div className="absolute inset-0 z-50 bg-stone-900/95 backdrop-blur flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl p-8 max-w-lg w-full text-center shadow-2xl animate-in zoom-in-95">
                                <IconTrophy className="w-24 h-24 text-amber-400 mx-auto mb-6" />
                                <h2 className="text-4xl font-black text-stone-800 mb-2">Spielende</h2>
                                <p className="text-stone-500 text-lg mb-8">Du hast <strong className="text-stone-900">{score}</strong> Punkte erzielt.</p>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setGameState('menu')} className="py-4 rounded-xl bg-stone-100 text-stone-600 font-bold hover:bg-stone-200">Menü</button>
                                    <button onClick={() => startGame(gameMode)} className="py-4 rounded-xl bg-amber-500 text-white font-bold hover:bg-amber-600 shadow-lg shadow-amber-500/25 flex items-center justify-center gap-2">
                                        <IconRotateCcw className="w-5 h-5" /> Replay
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </main>

                <footer className="bg-stone-900 text-stone-500 p-4 text-xs border-t border-stone-800 flex flex-col md:flex-row items-center justify-between gap-4 flex-shrink-0">
                    <div className="flex items-center gap-4">
                         <img src="https://www.welserschule.de/wp-content/uploads/2025/11/BS4_Logo_Web_ohneSlogan.jpg" alt="BS+ Welserschule Augsburg" className="h-8 opacity-80 hover:opacity-100 transition-opacity" />
                         <div className="flex flex-col">
                            <span className="font-bold text-stone-300">Johannes Heinrich</span>
                            <span>Erstellt mithilfe von Gemini &bull; 2025</span>
                         </div>
                    </div>
                    <div className="text-right">
                        Kartendaten basieren auf OpenStreetMap (vereinfacht) &bull; Bildungszwecke
                    </div>
                </footer>
            </div>
        );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AutobahnGame />);
    </script>
</body>
</html>